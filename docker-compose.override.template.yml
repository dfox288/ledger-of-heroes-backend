# =============================================================================
# Docker Compose Override Template for Worktree Environments
# =============================================================================
#
# This file is used by scripts/create-agent-worktree.sh to generate
# environment-specific overrides that allow multiple backend instances
# to run simultaneously without port/container conflicts.
#
# DO NOT use this file directly. Run the setup script instead:
#   ./scripts/create-agent-worktree.sh <instance-number> <branch-name>
#
# Placeholders replaced by setup script:
#   {{INSTANCE_ID}}  - Unique instance number (1, 2, 3, etc.)
#   {{NGINX_PORT}}   - Nginx port (8091, 8092, etc.)
#
# Worktrees only run php + nginx, connecting to shared services on main network.
# =============================================================================

services:
  php:
    container_name: loh_backend_php_{{INSTANCE_ID}}
    depends_on: !override []
    networks: !override
      - loh_network

  nginx:
    container_name: loh_backend_nginx_{{INSTANCE_ID}}
    ports: !override
      - "{{NGINX_PORT}}:80"
    depends_on: !override
      - php
    networks: !override
      - loh_network

  # Disable shared services - they run from main backend
  mysql:
    profiles: ["disabled"]
  meilisearch:
    profiles: ["disabled"]
  redis:
    profiles: ["disabled"]

# Use the main backend's network (external)
networks:
  loh_network:
    external: true
    name: backend_loh_network

# Define volumes (referenced by base file but unused here)
volumes:
  mysql_data:
  meilisearch_data:
  redis_data:
