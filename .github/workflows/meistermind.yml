# MeisterMind - AI Assistant for D&D Compendium
#
# This workflow:
# 1. Automatically analyzes new issues and provides initial assessment
# 2. Responds to @meistermind mentions in issues and PRs
#
# Place in: .github/workflows/meistermind.yml

name: MeisterMind

on:
  issues:
    types: [ opened ]
  issue_comment:
    types: [ created ]
  pull_request_review_comment:
    types: [ created ]

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Analyze new issues automatically
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  analyze-issue:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: [ self-hosted, claude-code ]
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Get issue content
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue view ${{ github.event.issue.number }} --json title,body,labels > /tmp/issue.json
          echo "title=$(jq -r '.title' /tmp/issue.json)" >> $GITHUB_OUTPUT

      - name: Analyze Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read issue content
          ISSUE_TITLE=$(jq -r '.title' /tmp/issue.json)
          ISSUE_BODY=$(jq -r '.body // "No description provided"' /tmp/issue.json)

          cat << EOF > /tmp/analyze-prompt.txt
          Analyze this GitHub issue. Be helpful and thorough, but don't explain the project back to me.

          Title: ${ISSUE_TITLE}

          Description:
          ${ISSUE_BODY}

          Provide:
          - What's being requested/reported
          - Which files/areas likely need changes
          - Complexity estimate (Low/Medium/High)
          - Suggested approach
          - Clarifying questions if needed

          Skip any preamble. Just analyze.
          EOF

          claude -p "$(cat /tmp/analyze-prompt.txt)" \
            --max-turns 3 \
            --allowedTools "Read" \
            > /tmp/analysis.txt 2>&1

          gh issue comment "${{ github.event.issue.number }}" \
            --body "ðŸŽ² **MeisterMind Analysis**

          $(cat /tmp/analysis.txt)

          ---
          *Need help? Mention @meistermind*"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Respond to @meistermind mentions
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  respond-to-mention:
    if: |
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      contains(github.event.comment.body, '@meistermind')
    runs-on: [ self-hosted, claude-code ]
    timeout-minutes: 15
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get full context
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"

          # Get issue/PR details
          gh issue view "$ISSUE_NUMBER" --json title,body,comments > /tmp/issue.json

          # Check if it's a PR
          if [ "${{ github.event.issue.pull_request }}" != "" ]; then
            echo "type=pr" >> $GITHUB_OUTPUT
            gh pr diff "$ISSUE_NUMBER" > /tmp/diff.txt 2>/dev/null || echo "" > /tmp/diff.txt
          else
            echo "type=issue" >> $GITHUB_OUTPUT
            echo "" > /tmp/diff.txt
          fi

          # Get recent comments for context (last 5)
          jq -r '.comments[-5:] | .[] | "[\(.author.login)]: \(.body)"' /tmp/issue.json > /tmp/comments.txt 2>/dev/null || echo "" > /tmp/comments.txt

      - name: Respond
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          ISSUE_TITLE=$(jq -r '.title' /tmp/issue.json)
          ISSUE_BODY=$(jq -r '.body // ""' /tmp/issue.json)
          REQUEST=$(echo "$COMMENT_BODY" | sed 's/@meistermind//gi' | xargs)

          cat << EOF > /tmp/prompt.txt
          You're MeisterMind, helping with this GitHub issue/PR.

          ISSUE: ${ISSUE_TITLE}

          DESCRIPTION:
          ${ISSUE_BODY}

          RECENT DISCUSSION:
          $(cat /tmp/comments.txt)

          EOF

          # Add diff context for PRs
          if [ -s /tmp/diff.txt ]; then
            echo "PR DIFF (truncated):" >> /tmp/prompt.txt
            head -150 /tmp/diff.txt >> /tmp/prompt.txt
            echo "" >> /tmp/prompt.txt
          fi

          cat << EOF >> /tmp/prompt.txt

          REQUEST: ${REQUEST}

          Be helpful and thorough. Don't explain the project or tech stack back to me - just answer the question.
          EOF

          claude -p "$(cat /tmp/prompt.txt)" \
            --max-turns 10 \
            --allowedTools "Read,Bash(git diff:*),Bash(git log:*),Bash(git show:*)" \
            > /tmp/response.txt 2>&1

          gh issue comment ${{ github.event.issue.number }} \
            --body "$(cat /tmp/response.txt)

          ---
          *ðŸŽ² @meistermind*"
